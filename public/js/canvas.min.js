/*!distanceEduGrunt <%= grunt.template.today("yyyy-mm-dd")*/function getNowTime(){var a=new Date,b=a.getFullYear(),c=a.getMonth()+1,d=a.getDate(),e=a.getHours(),f=a.getMinutes(),g=a.getSeconds();return b+"-"+c+"-"+d+" "+e+":"+f+":"+g}function scrollToBottom(){var a=$(".chatList")[0].scrollHeight;$(".chatList").scrollTop(a)}var room=io.connect("http://localhost:3000/room");room.on("connect",function(){room.emit("join room",curRoomName)}),room.on("ceshi",function(){console.log("33")}),room.on("ceshi other",function(){console.log("555")}),$("#fillTxt").blur(function(){var a=$("#fillTxt").val();0===a.length?($("#fillTxt").val(""),$("#fillTxt").hide(),paramter.point=[],paramter.ctn=""):(paramter.type="text",paramter.ctn=a,paramter.point=[txtStartPoint[0]-400,txtStartPoint[1]],DrawAction(paramter),$("#fillTxt").val(""),$("#fillTxt").hide(),paramter.point=[],paramter.ctn=""),room.emit("draw txt",null)});var curUser=userName;$("#chatBtn").click(function(){var a=$("#chatInput").val();0!==a.length&&(room.emit("add chat",{user:curUser,time:getNowTime(),ctn:encodeURI(a)}),$("#chatInput").val(""))}),room.on("chat msg student",function(a){var b="<li><p><span>"+decodeURI(a.ctn.user)+" </span><span>"+a.ctn.time+"</span><p>"+decodeURI(a.ctn.ctn,"utf-8")+"</p>";$("#chatCtn").append(b),scrollToBottom()}),room.on("chat msg slef",function(a){var b="<li><p><span>"+decodeURI(a.ctn.user)+" </span><span>"+a.ctn.time+"</span><p>"+decodeURI(a.ctn.ctn,"utf-8")+"</p>";$("#chatCtn").append(b),scrollToBottom()}),$(document).keydown(function(a){13==a.keyCode&&"text"!==cursor&&$("#chatBtn").click()});var drawFlag=!1,drawStartPoint=[];if(mouseFlag){$("#canvas").mouseover(function(){switch(cursor){case"line":$(".canvasBody").css("cursor","url(release/images/line.png),auto");break;case"earser":$(".canvasBody").css("cursor","url(release/images/eraser.png),auto");break;case"shape":$(".canvasBody").css("cursor","url(release/images/shape.png),auto");break;case"text":$(".canvasBody").css("cursor","url(release/images/text.png),auto");break;case"upload":$(".canvasBody").css("cursor","url(release/images/upload.png),han")}}),$("#canvas").mouseout(function(){$(".canvasBody").css("cursor","auto")}),$("#drawType>button").click(function(){var a=$("#drawType>button").index($(this));$(this).addClass("active").siblings("button").removeClass("active"),paramter.type=$(this).attr("type"),2===a?($("#shapeClassfy").show(),cursor="shape"):$("#shapeClassfy").hide(),0===a&&(cursor="line"),1===a&&(cursor="earser"),room.emit("draw style btn",a)}),$("#shapeClassfy>button").click(function(){var a=$("#shapeClassfy>button").index($(this));paramter.type=$(this).attr("type"),room.emit("draw shape style btn",a),$("#shapeClassfy").hide()}),$("#drawLineColor div button").click(function(){var a=$(this).attr("type");paramter.lineColor=a,$("#drawLineColor>p>span")[0].style.background=a,room.emit("draw line color",a)}),$("#drawColor div button").click(function(){var a=$(this).attr("type");paramter.fillColor="white"!=a?a:null,$("#drawColor>p>span")[0].style.background=a,room.emit("draw color",a)}),$("#drawLineWidth input").change(function(){var a=$("#drawLineWidth input").val();$("#drawLineWidth p span").text(a),room.emit("draw line width",a),paramter.lineWidth=a}),$("#drawLineStyle input").click(function(){var a=$("#drawLineStyle input").index($(this));paramter.lineStyle=0===a?[0,0]:[10,10],room.emit("draw line style",a)}),$("#canvas").mousedown(function(a){drawFlag=!0,drawStartPoint[0]=a.pageX-400,drawStartPoint[1]=a.pageY+20}),$(document).mousemove(function(a){room.emit("mouse location",[a.pageX,a.pageY]),drawFlag&&(paramter.point[0]=drawStartPoint[0],paramter.point[1]=drawStartPoint[1],paramter.point[2]=a.pageX-400,paramter.point[3]=a.pageY+20,DrawAction(paramter),paramter.point=[],room.emit("draw line",[drawStartPoint[0],drawStartPoint[1],a.pageX-400,a.pageY+20]),"segment"!==paramter.type&&"rect"!==paramter.type&&"circle"!==paramter.type&&"triangle"!==paramter.type&&(drawStartPoint[0]=a.pageX-400,drawStartPoint[1]=a.pageY+20))}),$("#canvas").mouseup(function(){drawFlag=!1,strightFlag=!1,drawStartPoint=[],paramter.point=[],room.emit("mouse up",null)}),$("#drawType button").eq(3).click(function(){cursor="text",paramter.type=null,room.emit("chose draw txt",null)}),$("#canvas").on("mousedown",function(a){"text"===cursor&&(txtStartPoint[0]=a.pageX,txtStartPoint[1]=a.pageY,$("#fillTxt").show(),$("#fillTxt").focus(),txtInputFlag=!0,room.emit("text input show",[a.pageX,a.pageY]))}),$("#canvas").on("mousemove",function(a){txtInputFlag===!0&&($("#fillTxt").css({top:txtStartPoint[1],left:txtStartPoint[0],width:a.pageX-txtStartPoint[0],height:a.pageY-txtStartPoint[1]}),room.emit("text input change",[a.pageX,a.pageY]))}),$(document).on("mouseup",function(){"text"===cursor&&(txtInputFlag=!1)}),$(document).keyup(function(){var a=$("#fillTxt").val();room.emit("text input ctn",encodeURI(a))}),$("#drawType>button").eq(4).click(function(){$("#uploadCtn").show(),cursor="upload"}),$("#file").fileupload({maxFileSize:5e6,done:function(a,b){"pdf"===b.result.type?($("#uploadCtn progress").attr("value","0"),$("#uploadCtn").hide(),pdfUrl=b.result.url,$("#pdfWrap").show(),pdfShow(pdfUrl),room.emit("upload pdf",b.result.url)):($("#uploadCtn progress").attr("value","0"),$("#uploadCtn").hide(),paramter.type="upload",paramter.ctn=b.result,DrawAction(paramter),room.emit("upload file",b.result),paramter.type=null,paramter.ctn=null)},progressall:function(a,b){var c=100*Math.floor(b.loaded/b.total);$("#uploadCtn progress").attr("value",c)}}),$("#pdfPre").click(function(){1!==nums&&(console.log("AAA"+nums),nums--,pdfShow(pdfUrl),console.log("BBB"+nums),room.emit("pdf pre",null))}),$("#pdfNext").click(function(){nums!==totalNum&&(console.log("AAA"+nums),nums++,pdfShow(pdfUrl),console.log("BBB"+nums),room.emit("pdf next",null))}),$("#pdfColse").click(function(){$("#pdfWrap").hide(),room.emit("pdf close",null)}),$("#pdfWrap").scroll(function(){var a=$("#pdfWrap").scrollTop();room.emit("pdf scroll",a)}),$("#createLayer").click(function(){for(var a=null,b=0;b<layerArry.length;b++)layerArry[b]==layer&&(a=layerArry[b]);a.hide(),a.draw(),layerArry.push(new Kinetic.Layer),stage.add(layerArry[layerArry.length-1]),layer=layerArry[layerArry.length-1],room.emit("create layer",null)}),$("#preLayer").click(function(){for(var a=null,b=0;b<layerArry.length;b++){if(layerArry[b]==layer){if(console.log(b),0===b)return;a=b-1}layerArry[b].hide(),layerArry[b].draw()}layer=layerArry[a],layerArry[a].show(),layerArry[a].draw(),room.emit("pre layer",null)}),$("#nextLayer").click(function(){for(var a=null,b=0;b<layerArry.length;b++){if(layerArry[b]==layer){if(console.log("hou"+b),b===layerArry.length-1)return;a=b+1}layerArry[b].hide(),layerArry[b].draw()}layer=layerArry[a],layerArry[a].show(),layerArry[a].draw(),room.emit("next layer",null)});var count=0;$("#saveAll").click(function(){for(var a=1;2>a;a++){for(var b=0;b<layerArry.length;b++)layerArry[b].hide(),layerArry[b].draw();layerArry[a].show(),layerArry[a].draw(),stage.toDataURL({callback:function(a){console.log(a),window.open(a)}})}})}room.on("mouse location msg",function(a){$("#cursor").show(),$("#cursor").css({left:a.data[0],top:a.data[1]})}),room.on("draw style btn msg",function(a){$("#drawType>button").eq(a.index).addClass("active").siblings("button").removeClass("active"),2===a.index?$("#shapeClassfy").show():$("#shapeClassfy").hide(),cursor=$("#drawType>button").eq(a.index).attr("type"),paramter.type=$("#drawType>button").eq(a.index).attr("type")}),room.on("draw shape style btn msg",function(a){$("#shapeClassfy").hide(),paramter.type=$("#shapeClassfy>button").eq(a.index).attr("type")}),room.on("draw line msg",function(a){paramter.point[0]=a.para[0],paramter.point[1]=a.para[1],paramter.point[2]=a.para[2],paramter.point[3]=a.para[3],DrawAction(paramter)}),room.on("draw line color msg",function(a){$("#drawLineColor>p>span")[0].style.background=a.color,paramter.lineColor=a.color}),room.on("draw color msg",function(a){$("#drawColor>p>span")[0].style.background=a.color,paramter.fillColor="white"!=a.color?a.color:null}),room.on("draw line width msg",function(a){$("#drawLineWidth p span").text(a.value),$("#drawLineWidth input").val(a.value),paramter.lineWidth=a.value}),room.on("draw line style msg",function(a){paramter.lineStyle=0===a.index?[0,0]:[10,10],console.log(a.index),$("#drawLineStyle input").eq(a.index).click()}),room.on("mouse up msg",function(){drawFlag=!1,strightFlag=!1,drawStartPoint=[],paramter.point=[]}),room.on("chose draw txt msg",function(){console.log("chose"),cursor="text",paramter.type=null}),room.on("text input show msg",function(a){txtStartPoint[0]=a.pos[0],txtStartPoint[1]=a.pos[1],$("#fillTxt").show(),$("#fillTxt").focus()}),room.on("text input change msg",function(a){$("#fillTxt").css({top:txtStartPoint[1],left:txtStartPoint[0],width:a.pos[0]-txtStartPoint[0],height:a.pos[1]-txtStartPoint[1]})}),room.on("text input ctn msg",function(a){$("#fillTxt").val(decodeURI(a.ctn))}),room.on("draw txt msg",function(){var a=$("#fillTxt").val();0===a.length?($("#fillTxt").val(""),$("#fillTxt").hide(),paramter.point=[],paramter.ctn=""):(paramter.type="text",paramter.ctn=a,paramter.point=[txtStartPoint[0]-400,txtStartPoint[1]],DrawAction(paramter),$("#fillTxt").val(""),$("#fillTxt").hide(),paramter.point=[],paramter.ctn="")}),room.on("upload file msg",function(a){paramter.type="upload",paramter.ctn=a.data,DrawAction(paramter),paramter.type=null,paramter.ctn=null}),room.on("upload pdf msg",function(a){pdfUrl=a.url,$("#pdfWrap").show(),pdfShow(pdfUrl)}),room.on("pdf pre msg",function(){console.log("5555"),nums--,pdfShow(pdfUrl)}),room.on("pdf next msg",function(){nums++,pdfShow(pdfUrl)}),room.on("pdf close msg",function(){$("#pdfWrap").hide()}),room.on("pdf scroll msg",function(a){console.log(";5"),console.log(a),$("#pdfWrap").scrollTop(a.height)}),room.on("create layer msg",function(){for(var a=null,b=0;b<layerArry.length;b++)layerArry[b]==layer&&(a=layerArry[b]);a.hide(),a.draw(),layerArry.push(new Kinetic.Layer),stage.add(layerArry[layerArry.length-1]),layer=layerArry[layerArry.length-1]}),room.on("next layer msg",function(){for(var a=null,b=0;b<layerArry.length;b++){if(layerArry[b]==layer){if(console.log("hou"+b),b===layerArry.length-1)return;a=b+1}layerArry[b].hide(),layerArry[b].draw()}layer=layerArry[a],layerArry[a].show(),layerArry[a].draw()}),room.on("pre layer msg",function(){for(var a=null,b=0;b<layerArry.length;b++){if(layerArry[b]==layer){if(console.log(b),0===b)return;a=b-1}layerArry[b].hide(),layerArry[b].draw()}layer=layerArry[a],layerArry[a].show(),layerArry[a].draw()});