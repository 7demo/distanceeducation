/*!distanceEduGrunt <%= grunt.template.today("yyyy-mm-dd")*/var strightFlag=!1,cursor="line",shapes=[],memory=[],txtMemory=[],txtStartPoint=[],txtInputFlag=!1,moveTarget=null,dragImage=!1,ss=null,paramter={type:"line",point:[],lineWidth:"1",lineStyle:[0,0],lineColor:"black",fillColor:null,ctn:null},stage=new Kinetic.Stage({container:"canvas",width:$(window).width()-402,height:$(window).height()-70}),layerArry=[];layerArry.push(new Kinetic.Layer),stage.add(layerArry[layerArry.length-1]);var layer=layerArry[layerArry.length-1],DrawAction=function(a){if(null!==a)switch(a.type){case"line":!function(){var b=new Kinetic.Line({points:a.point,stroke:a.lineColor,strokeWidth:a.lineWidth,lineCap:"round",lineJoin:"round",dash:a.lineStyle,tension:1});shapes.push(b),layer.add(b),layer.draw()}(),paramter.point=[];break;case"segment":!function(){strightFlag&&shapes.length>0&&(shapes[shapes.length-1].hide(),shapes.splice(shapes.length-1,1),layer.draw());var b=new Kinetic.Line({points:a.point,stroke:a.lineColor,strokeWidth:a.lineWidth,lineCap:"round",lineJoin:"round",dash:a.lineStyle,tension:1});shapes.push(b),layer.add(b),layer.draw()}(),paramter.point=[],strightFlag=!0;break;case"circle":!function(){strightFlag&&shapes.length>0&&(shapes[shapes.length-1].hide(),shapes.splice(shapes.length-1,1),layer.draw());var b=a.point[0],c=a.point[1],d=a.point[2],e=a.point[3],f=d-b,g=e-c,h=Math.floor(Math.pow(f*f+g*g,.5)),i=new Kinetic.Circle({x:b,y:c,radius:Math.floor(h),stroke:a.lineColor,fill:a.fillColor,dash:a.lineStyle,strokeWidth:a.lineWidth});shapes.push(i),layer.add(i),layer.draw()}(),paramter.point=[],strightFlag=!0;break;case"triangle":!function(){strightFlag&&shapes.length>0&&(shapes[shapes.length-1].hide(),shapes.splice(shapes.length-1,1),layer.draw());var b=[];b[0]=Math.floor((a.point[0]+a.point[2])/2),b[1]=Math.floor(1.73*b[0]/2);var c=new Kinetic.Line({points:[a.point[0],a.point[1],b[0],b[1],a.point[2],a.point[3]],stroke:a.lineColor,fill:a.fillColor,strokeWidth:a.lineWidth,dash:a.lineStyle,closed:!0});shapes.push(c),layer.add(c),layer.draw()}(),paramter.point=[],strightFlag=!0;break;case"rect":!function(){strightFlag&&shapes.length>0&&(shapes[shapes.length-1].hide(),shapes.splice(shapes.length-1,1),layer.draw());var b=a.point[0],c=a.point[1],d=a.point[2],e=a.point[3],f=d-b,g=e-c,h=new Kinetic.Rect({x:b,y:c,width:f,height:g,stroke:a.lineColor,dash:a.lineStyle,fill:"null"==a.fillColor?null:a.fillColor,strokeWidth:a.lineWidth});shapes.push(h),layer.add(h),layer.draw()}(),paramter.point=[],strightFlag=!0;break;case"earser":!function(){var b=new Kinetic.Line({points:a.point,stroke:"#fff",strokeWidth:1.5*a.lineWidth<6?6:2*a.lineWidth,lineCap:"round",lineJoin:"round",tension:1});shapes.push(b),layer.add(b),layer.draw()}(),paramter.point=[];break;case"text":!function(){if(null!==a.txt){var b=new Kinetic.Text({x:a.point[0],y:a.point[1],text:a.ctn,fill:a.lineColor,fontSize:16+4*a.lineWidth});shapes.push(b),txtMemory[0]=b,layer.add(b),layer.draw()}}();break;case"upload":!function(){var b=new Image;b.onload=function(){var a=new Kinetic.Image({x:400,y:50,image:b,draggable:!0});shapes.push(a),layer.add(a),layer.draw(),moveTarget=null,a.on("mousedown",function(a){moveTarget=a.target._id,room.emit("drag image start","333")}),$(document).mousemove(function(){if(moveTarget){for(var a=null,b=0;b<shapes.length;b++)shapes[b]._id==moveTarget&&(a=shapes[b]);var c=[a.x(),a.y(),moveTarget];room.emit("drag image on",c)}}),a.on("mouseup",function(){moveTarget=null,room.emit("drag image end",null)})},b.src=a.ctn}()}};room.on("drag image start msg",function(){dragImage=!0}),room.on("drag image on msg",function(a){if(dragImage)for(var b=0;b<shapes.length;b++)if(shapes[b]._id==a.ctn[2]){{shapes[b]}ss=shapes[b],shapes[b].x(a.ctn[0]),shapes[b].y(a.ctn[1]),layer.draw()}}),room.on("drag image end msg",function(){layer.draw(),dragImage=!1}),$("#toolCancel").click(function(){0!==shapes.length&&(shapes[shapes.length-1].hide(),memory[memory.length]=shapes.slice(shapes.length-1),shapes.splice(shapes.length-1,1),layer.draw(),room.emit("drawCancel",null))}),room.on("drawOtherCancel",function(){0!==shapes.length&&(shapes[shapes.length-1].hide(),memory[memory.length]=shapes.slice(shapes.length-1),shapes.splice(shapes.length-1,1),layer.draw())}),$("#toolRepainter").click(function(){0!==memory.length&&(shapes[shapes.length]=memory[memory.length-1][0],memory.splice(memory.length-1,1),shapes[shapes.length-1].show(),layer.draw(),room.emit("drawRepainter",null))}),room.on("drawOtherRepainter",function(){0!==memory.length&&(shapes[shapes.length]=memory[memory.length-1][0],memory.splice(memory.length-1,1),shapes[shapes.length-1].show(),layer.draw())});